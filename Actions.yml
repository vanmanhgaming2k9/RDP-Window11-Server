name: ğŸš€ SEVER vanmanhgaming

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '2160h'
        type: choice
        options:
        - '2160h'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ğŸ¤– vanmanhgaming RDP SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          
          $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
          for($i=0; $i -lt 10; $i++){
            Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i%8])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Milliseconds 100
          }
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!                    " -ForegroundColor Green

      # Cáº¤U HÃŒNH NÃ‚NG CAO
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host "ğŸ› ï¸  ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow

          $steps = @(
            @{Name="Báº­t Remote Desktop"; Script={ 
                Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
            }},
            @{Name="Táº¯t xÃ¡c thá»±c máº¡ng"; Script={
                Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
            }},
            @{Name="Cáº¥u hÃ¬nh báº£o máº­t RDP"; Script={
                Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' "SecurityLayer" 0 -Force
            }},
            @{Name="Má»Ÿ port 3389 firewall"; Script={
                netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
                netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
            }},
            @{Name="Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥"; Script={
                Set-Service -Name TermService -StartupType Automatic
                Start-Service TermService
            }}
          )

          foreach($step in $steps){
            Write-Host "â”‚ ğŸ“‹ $($step.Name)..." -NoNewline
            try{ & $step.Script; Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green }
            catch{ Write-Host "`râ”‚ âš ï¸  Lá»—i nhá» â€“ bá» qua" -ForegroundColor Yellow }
            Start-Sleep -Milliseconds 400
          }

      # ğŸ”¥ CÃ€I VS CODE â€“ NODE.JS â€“ PYTHON 3.11.9
      - name: ğŸ“¦ Tá»° Äá»˜NG CÃ€I VS CODE + NODE.JS + PYTHON 3.11.9
        run: |
          Write-Host "ğŸš€ CÃ i Ä‘áº·t á»©ng dá»¥ng cáº§n thiáº¿t..." -ForegroundColor Yellow

          Write-Host "ğŸ“¥ CÃ i Visual Studio Code..."
          winget install --id Microsoft.VisualStudioCode -e --silent

          Write-Host "ğŸ“¥ CÃ i Node.js LTS má»›i nháº¥t..."
          winget install --id OpenJS.NodeJS.LTS -e --silent

          Write-Host "ğŸ“¥ CÃ i Python 3.11.9..."
          winget install --id Python.Python.3.11 --version 3.11.9 -e --silent

          Write-Host "ğŸ‰ ÄÃ£ cÃ i Ä‘áº·t toÃ n bá»™ Developer Tools!" -ForegroundColor Green

      # Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host "ğŸ‘¤ Táº¡o tÃ i khoáº£n Premium..." -ForegroundColor Yellow

          function New-PremiumPassword {
              $upper='ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower='abcdefghijkmnpqrstuvwxyz'
              $num='23456789'
              $all=$upper+$lower+$num
              $pw = $upper[(Get-Random -Max $upper.Length)]
              $pw+= $lower[(Get-Random -Max $lower.Length)]
              $pw+= $num[(Get-Random -Max $num.Length)]
              for($i=1;$i -le 5;$i++){ $pw += $all[(Get-Random -Max $all.Length)] }
              -join ($pw.ToCharArray() | Sort-Object {Get-Random})
          }

          if($env:CUSTOM_RDP_PASS){
            $pass=$env:CUSTOM_RDP_PASS
          } else {
            $pass=New-PremiumPassword
          }

          $secPass=ConvertTo-SecureString $pass -AsPlainText -Force

          Remove-LocalUser -Name "vanmanhgaming" -ErrorAction SilentlyContinue
          New-LocalUser -Name "vanmanhgaming" -Password $secPass -AccountNeverExpires
          Add-LocalGroupMember -Group Administrators -Member vanmanhgaming
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member vanmanhgaming

          Enable-LocalUser -Name vanmanhgaming
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV
          echo "$pass" > $env:TEMP\rdp_password.txt

          Write-Host "âœ… User Premium Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      # KIá»‚M TRA QUYá»€N
      - name: ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG
        run: |
          Write-Host "ğŸ” Kiá»ƒm tra quyá»n..." -ForegroundColor Yellow
          Write-Host "OK!"

      # TAILSCALE
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "ğŸŒ CÃ i Tailscale..." -ForegroundColor Yellow
          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --reset
          $ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      # HIá»‚N THá»Š INFO
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $pass = Get-Content $env:TEMP\rdp_password.txt
          Write-Host "====================================="
          Write-Host "  ğŸŒ IP: $env:TAILSCALE_IP"
          Write-Host "  ğŸ‘¤ User: vanmanhgaming"
          Write-Host "  ğŸ” Pass: $pass"
          Write-Host "  ğŸ”Œ Port: 3389"
          Write-Host "====================================="

      # DUY TRÃŒ PHIÃŠN
      - name: â³ DUY TRÃŒ PHIÃŠN
        run: |
          Write-Host "â³ Dang duy trÃ¬ phiÃªn..."

          while($true){ Start-Sleep -Seconds 30 }

      # Dá»ŒN Dáº¸P
      - name: ğŸ§¹ Dá»ŒN Dáº¸P
        if: always()
        run: |
          Remove-Item "$env:TEMP\rdp_password.txt" -Force -ErrorAction SilentlyContinue
          Disable-LocalUser -Name "vanmanhgaming" -ErrorAction SilentlyContinue
          Write-Host "ğŸ§¹ ÄÃ£ dá»n dáº¹p phiÃªn thÃ nh cÃ´ng!" -ForegroundColor Green
